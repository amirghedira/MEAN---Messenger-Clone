<section *ngIf="!loading" class="chat">

  <div *ngIf="openBlockMsgModal">
    <div class="backdrop-container" (click)="onOpenBlockMsgModal(false)">
    </div>
    <div class="modal-container">
      <div class="modal-title">
        <h4 class="user-name">
          Bloquer les messages
        </h4>
      </div>
      <div class="modal-content-text">
        <p>
          Vous ne recevrez plus de messages et d’appels de Lotfi dans Messenger.
        </p>
      </div>
      <div class="modal-footer">
        <div>
          <button class="button-success" (click)="onOpenBlockMsgModal(false)">Annuler</button>
          <button class="button-danger">Bloquer les messages</button>
        </div>

      </div>
    </div>
  </div>



  <div *ngIf="openIgnoreMessages">
    <div class="backdrop-container" (click)="onOpenIgnoreMessages(false)">

    </div>
    <div class="modal-container">
      <div class="modal-title">
        <h4 class="user-name">
          Ignorer cette conversation ?
        </h4>
      </div>
      <div class="modal-content-text">
        <p>
          Vous ne recevrez pas de notification lorsque Moez vous enverra des messages, et la conversation sera déplacée
          vers les messages filtrés. Nous n’informerons pas Moez que ses messages ont été ignorés. </p>
      </div>
      <div class="modal-footer">
        <div>
          <button class="button-success" (click)="onOpenIgnoreMessages(false)">Annuler</button>
          <button class="button-danger" style="font-weight: 500;">Ignorer les messages</button>
        </div>

      </div>
    </div>

  </div>


  <div *ngIf="openEditPseudoModal">
    <div class="backdrop-container" (click)="onOpenEditPseudoModal(false)">
    </div>
    <div class="pseudo-container">
      <div class="modal-header">
        <button class="button-success" (click)="onOpenEditPseudoModal(false)">Annuler</button>
        <h4 class="user-name" style="font-size: 15px;margin: 0;"> Modifier les pseudos</h4>
      </div>
      <div class="users-container">

        <div class="user-edit-pseudo" (click)="onOpenPseudoModal(true)">
          <img src="assets/img/users/9.jpg" class="img-circle" style="height: 30px;width: 30px;margin-right: 10px;"
            alt="">
          <h4 class="user-name" style="margin:0;font-size: 15px;font-weight: 400;">
            lotfi ghedira
          </h4>
        </div>
        <div class="user-edit-pseudo" (click)="onOpenPseudoModal(true)">
          <img src="assets/img/users/9.jpg" class="img-circle" style="height: 30px;width: 30px;margin-right: 10px;"
            alt="">
          <h4 class="user-name" style="margin:0;font-size: 15px;font-weight: 400;">
            lotfi ghedira
          </h4>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="openPseudoModal">
    <div class="backdrop-container" (click)="onOpenPseudoModal(false)">
    </div>
    <div class="modal-container">
      <div class="modal-title">
        <h4 class="user-name">
          Modifier le pseudo de Moez Lansari
        </h4>
        <p>
          Tous les participants de cette conversation le verront. </p>
      </div>
      <div class="modal-content-input">
        <input class="input-pseudo" type="text" placeholder="Moez lansari" />
      </div>
      <div class="modal-footer">
        <div>
          <button class="button-success" (click)="onOpenPseudoModal(false)">Annuler</button>
          <button class="button-success" style="font-weight:500;">Enregistrer</button>
        </div>

      </div>
    </div>

  </div>


  <div *ngIf="openColorsModal">
    <div class="backdrop-container" (click)="onOpenColorsModal(false)">

    </div>

    <div class="modal-container-colors">
      <div class="modal-title">
        <h4 class="user-name">
          Choisissez une couleur pour cette conversation
        </h4>
        <p>
          Tous les participants de cette conversation le verront. </p>
      </div>
      <div>
        <div class="modal-content-colors">
          <span class="color-item" style="background-color:rgb(0, 132, 255);"></span>
          <span class="color-item" style="background-color:rgb(68, 190, 199);"></span>
          <span class="color-item" style="background-color:rgb(255, 195, 0);"></span>
          <span class="color-item" style="background-color:rgb(250, 60, 76);"></span>

        </div>
        <div class="modal-content-colors">
          <span class="color-item" style="background-color:rgb(214, 150, 187);"></span>
          <span class="color-item" style="background-color:rgb(19, 207, 19);"></span>
          <span class="color-item" style="background-color:rgb(255, 126, 41);"></span>
          <span class="color-item" style="background-color:rgb(230, 133, 133);"></span>

        </div>
        <div class="modal-content-colors">
          <span class="color-item" style="background-color:rgb(118, 70, 255);"></span>
          <span class="color-item" style="background-color:rgb(32, 206, 245);"></span>
          <span class="color-item" style="background-color:rgb(255, 92, 161);"></span>
        </div>

      </div>
      <div class="modal-footer">
        <div>
          <button class="button-success" (click)="onOpenColorsModal(false)">Annuler</button>
        </div>

      </div>
    </div>

  </div>

  <div class="container-fluid">
    <div class="row" style="background-color: white;">

      <div class="messages-box">
        <div class="row">
          <div class="col-lg-4 col-md-12 no-pdd">
            <div class="messages-container">
              <div class="message-header">
                <div class="message-title">
                  <div class="search-area">
                    <div class="input-field">
                      <input placeholder="Search" type="text" [(ngModel)]="searchTerms" [ngbTypeahead]="search" />
                      <!-- [ngbTypeahead]="search" -->
                      <i class="fa fa-search"></i>
                    </div>
                  </div>
                </div>

              </div>
              <div class="messages-list" *ngIf="!checkUserAvailabe()">
                <ul>
                  <li>
                    <div class=" user-message-details">

                      <div class="user-message-info">
                        <div class="user-display">

                          <h4>No conversations available</h4>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="messages-list" *ngIf="checkUserAvailabe() && !loading && searchTerms.length==0">
                <ul style="list-style-type: none;" *ngFor="let conversation of userConversations">
                  <li (mouseenter)="setFocusConversation(conversation._id,true)"
                    (mouseleave)="setFocusConversation(conversation._idfalse)"
                    [ngClass]="conversation._id == currentConversation?._id ? 'message-item active' : 'message-item'">
                    <div class="user-message-details" (click)="onOpenConvers(conversation._id)">
                      <div class="user-message-img">
                        <span *ngIf="conversation.users[indexUserDest(conversation._id)].connection.status"
                          class="online-status on-picture"></span>
                        <img src="assets/img/users/9.jpg" class="img-circle" alt="">
                      </div>
                      <div class="user-message-info">
                        <div style="align-self: center;">
                          <div class="user-display">

                            <h4 [ngClass]="lastMessageSeen(conversation._id) ? 'read-userinfo' : 'not-read-userinfo'">
                              {{conversation.users[indexUserDest(conversation._id)].name}}
                              {{conversation.users[indexUserDest(conversation._id)].surname}}</h4>
                          </div>

                          <div style="display: flex; align-items: center;">
                            <span style="font-weight: 400;"
                              *ngIf="conversation.messages[conversation.messages.length-1].sender == connectedUser._id">Vous:
                            </span>

                            <p [ngClass]="lastMessageSeen(conversation._id) ? 'message-field-read' : 'message-field-not-read'"
                              *ngIf="conversation.messages.length>0">

                              {{conversation.messages[conversation.messages.length-1].content}}

                            </p>

                            <span class="message-time">.
                              {{conversationDateFormat(conversation.messages[conversation.messages.length -1].date)}}</span>

                          </div>

                          <p [ngClass]="lastMessageSeen(conversation._id) ? 'message-field-read' : 'message-field-not-read'"
                            *ngIf="conversation.messages.length==0">
                            say hello to {{conversation.users[indexUserDest(conversation._id)].surname}}<span
                              class="message-time">.
                              {{conversationDateFormat(conversation.messages[conversation.messages.length -1].date)}}</span>
                          </p>

                        </div>
                        <div *ngIf="focusConversation.id==conversation._id && focusConversation.status"
                          class="notification-container">
                          <div class="dropdown">
                            <i class=" fas fa-ellipsis-h" id="dropdownMenuButton" data-toggle="dropdown"></i>

                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                              <a class="dropdown-item" href="#">Action</a>
                              <a class="dropdown-item" href="#">Another action</a>
                              <a class="dropdown-item" href="#">Something else here</a>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="focusConversation.id!=conversation._id || !focusConversation.status"
                          class="notification-container">
                          <img *ngIf="showSeenPicture(conversation._id)" src="assets/img/users/6.jpg"
                            class="seen-message-image" alt="">
                          <span *ngIf="!lastMessageSeen(conversation._id)" class="message-notification"></span>
                        </div>
                      </div>
                      <!--/ user-message-info -->
                    </div>
                    <!--/ user-message-details -->
                  </li>
                </ul>
              </div>

              <div class="messages-list" *ngIf="!loadingSearch && checkUserAvailabe() && searchTerms.length>0">
                <ul style="list-style-type: none;" *ngFor="let user of searchedUsers">
                  <li class="message-item">
                    <div class="user-message-details" (click)="createdConversation(user)">
                      <div class="user-message-img">
                        <span class="online-status on-picture"></span>
                        <img src="assets/img/users/9.jpg" class="img-circle" alt="">
                      </div>
                      <div class="user-message-info">
                        <div style="align-self: center;">
                          <div class="user-display">

                            <h4 class="not-read-userinfo">{{user.name}}
                              {{user.surname}}</h4>
                          </div>

                          <!-- <p class="message-field-not-read">
                            {{conversation.messages[conversation.messages.length-1].content}}<span
                              class="message-time">. 15:55</span></p> -->

                        </div>
                      </div>
                      <!--/ user-message-info -->
                    </div>
                    <!--/ user-message-details -->
                  </li>
                </ul>
              </div>
              <!--/ messages-list -->

            </div>
            <!--/ messages-container-->
          </div>
          <!--/ col-lg-4 -->
          <div *ngIf="selectedProfileInfo" class="col-lg-8 col-md-12 pd-right-none pd-left-none">
            <div class="conversation-box">
              <div style="padding-top: 23px;">
                <div class="user-message-details" style="align-items: center;justify-content: flex-end">
                  <i class=" fas fa-info-circle user-profile-info-accessed" (click)="showUserInfo(false)"></i>
                </div>
              </div>
              <div class="profile-info-container">
                <div style="display: flex;justify-content: center;align-items: center;">
                  <img src="assets/img/users/6.jpg" class="img-responsive img-circle"
                    style="width: 100px;height: 100px;" alt="">
                </div>
                <div style="display: flex;justify-content: center;align-items: center;padding-top: 10px;">
                  <h4 class="user-name">
                    {{currentConversation.users[destinationUser].name }}
                    {{currentConversation.users[destinationUser].surname}}
                  </h4>
                </div>
                <div style="display: flex;justify-content: center;align-items: center;padding-top: 10px;">
                  <h5 style=" margin: 0; font-weight: 400;color: #999999;">
                    {{TransformDateOnline(currentConversation.users[destinationUser].connection.lastVisit)}}</h5>
                </div>

                <div style="display: flex;justify-content: center;align-items: center;padding-top: 20px;">
                  <h4 class="field-title">
                    Member since: <span
                      class="field-content">{{transformDateJoin(currentConversation.users[destinationUser].joinDate)}}</span>
                  </h4>

                </div>
                <div
                  style="display: flex;justify-content: center;align-items: center;padding-top: 10px;padding-bottom: 20px;">
                  <h4 class="field-title">
                    Phone: <span
                      class="field-content">{{transformDateJoin(currentConversation.users[destinationUser].joinDate)}}</span>
                  </h4>

                </div>
                <div class="field-container" (click)="onOpenColorsModal(true)">
                  <h4 class="field-title">
                    Theme
                  </h4>
                  <div class="conversation-theme">

                    <span class="white-circle"></span>
                  </div>

                </div>
                <div class="field-container" (click)="onOpenEditPseudoModal(true)">
                  <h4 class="field-title">
                    Pseudos
                  </h4>

                </div>
                <div class="field-container">
                  <h4 class="field-title">
                    Archiver la conversation
                  </h4>

                </div>
                <div class="field-container">
                  <h4 class="field-title">
                    Supprimer la conversation
                  </h4>

                </div>
                <div class="field-container" (click)="onOpenIgnoreMessages(true)">
                  <h4 class="field-title">
                    Ignorer les messages
                  </h4>
                </div>
                <div class="field-container" (click)="onOpenBlockMsgModal(true)">
                  <h4 class="field-title">
                    Bloquer {{currentConversation.users[destinationUser].surname}}
                  </h4>
                </div>


              </div>
            </div>
          </div>

          <div *ngIf="selectedConversation && !loadingMessages" class="col-lg-8 col-md-12 pd-right-none pd-left-none">
            <div class="conversation-box">
              <div class="conversation-header">
                <div class="user-message-details">
                  <div class="user-message-img">
                    <img src="assets/img/users/6.jpg" class="img-responsive img-circle" alt="">
                  </div>
                  <div class="user-message-header">
                    <h4 class="user-name">{{currentConversation.users[destinationUser].name}}
                      {{currentConversation.users[destinationUser].surname}}
                    </h4>
                    <div style="display: flex; align-items: center;">
                      <span *ngIf="currentConversation.users[destinationUser].connection.status"
                        class="online-status"></span>
                      <h5 *ngIf="currentConversation.users[destinationUser].connection.status"
                        style="margin: 0; font-weight: 400;color: #999999;">En ligne</h5>
                      <h5 *ngIf="!currentConversation.users[destinationUser].connection.status"
                        style="margin: 0; font-weight: 400;color: #999999;">
                        {{TransformDateOnline(currentConversation.users[destinationUser].connection.lastVisit)}}</h5>

                    </div>

                  </div>

                  <i class="fas fa-info-circle user-profile-info" (click)="showUserInfo(true)"></i>
                  <!--/ user-message-info -->
                </div>
                <!--/ user-message-details -->
              </div>
              <!--/ conversation-header -->

              <div class="conversation-container">
                <div *ngIf="imagesToSend.length >0" class="add-image-container">
                  <div *ngFor="let image of imagesToSend">
                    <div class="image-to-send" [style.background-image]="'url('+image+')'">
                      <i class="far fa-times-circle delete-icon" (click)="onDeleteImage(image)"></i>
                    </div>
                  </div>
                </div>
                <div *ngIf="currentConversation.messages.length==0">
                  <div style="display: flex;justify-content: center;">
                    <span class="time-posted" style="color: #999999;">1:55 PM</span>
                  </div>
                  <div style="display: flex;justify-content: center;">
                    <div style="display: flex;">
                      <img src="assets/img/users/6.jpg" style="border: 2px solid white;" class="image-in-container"
                        alt="">
                      <img src="assets/img/users/6.jpg" style="margin-left: -11px; border: 2px solid white;"
                        class="image-in-container" alt="">
                    </div>

                  </div>
                  <div style="display: flex;justify-content: center; color: #999999; font-size: 12px;">
                    Bienvenue à vous deux sur Messenger.
                  </div>
                </div>
                <div *ngIf="currentConversation.messages.length>0" style="position: relative;">
                  <div *ngFor="let message of currentConversation.messages">
                    <div *ngIf=" !checkSenderMsg(message.sender)" class="convo-box convo-left">
                      <div class="convo-area-left">
                        <div style="display: flex; align-items: flex-end;">
                          <img src="assets/img/users/6.jpg" alt="" class="conversation-user-image">
                        </div>
                        <div class="convo-message-left">
                          <p>{{message.content}}</p>
                          <!-- <img class="display-image-sended"
                            src="https://scontent.ftun2-1.fna.fbcdn.net/v/t1.15752-9/116290480_324011222303730_8181589891671855193_n.jpg?_nc_cat=108&_nc_sid=b96e70&_nc_ohc=Ptl-O8gjlhcAX9Y9kTD&_nc_ht=scontent.ftun2-1.fna&oh=922468e4c059692b79f009e8e0ed3581&oe=5F47F1D7" /> -->

                          <span class="tooltiptext-left">
                            <p>{{transformDateMessage(message.date)}}</p>
                          </span>
                        </div>
                      </div>

                    </div>

                    <div *ngIf="checkSenderMsg(message.sender)" class="convo-box convo-right">
                      <div class="convo-area-right">
                        <div class="convo-message-right">
                          <span class="tooltiptext-right">
                            <p>{{transformDateMessage(message.date)}}</p>
                          </span>
                          <div class="convo-message-content">
                            <p>{{message.content}}</p>
                            <span *ngIf="message.seen.state && isLastMessage(message._id)" class="time-posted">Vu:
                              {{formatSeenDate(message.seen.seenDate)}} </span>
                          </div>

                        </div>

                        <div style="display: flex; align-items: flex-end;">
                          <img src="assets/img/users/2.jpg" alt="" class="conversation-user-image">
                        </div>
                      </div>
                    </div>
                  </div>

                </div>

                <!--/ convo-box -->
                <!--/ convo-box -->
              </div>
              <!--/ conversation-container -->
              <div class="type_messages">
                <div class="input-field">
                  <i class="fas fa-image send-message-icon" style="font-size: 24px; padding-right: 10px;"
                    (click)="uploadImageClicked()">
                  </i>
                  <textarea [minRows]="1" autosize placeholder="Type a new message" name="currentMessage"
                    id="currentMessage" (focus)="messageField()" [(ngModel)]="currentMessage"></textarea>
                  <ul class="imoji">
                    <li>
                      <i *ngIf="currentMessage!=''" class="fas fa-paper-plane send-message-icon"
                        (click)="onSendMessage()"></i>
                      <i *ngIf="currentMessage==''" class="fas fa-thumbs-up send-message-icon"></i>
                    </li>
                  </ul>

                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
      <input type="file" id="uploadimage" style="display: none;" (change)="handlefileInput($event.target.files)"
        multiple />

    </div>
  </div>
</section>
